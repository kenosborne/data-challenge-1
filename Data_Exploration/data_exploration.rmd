---
title: "Data_Exploration"
author: "Kenneth L Osborne"
date: "August 25, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
suppressPackageStartupMessages(library(magrittr))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
```


# Data Exploration

Data Exploration

Challenge 1: Data Exploration
To complete this challenge:

1. Download the Adventure Works data files - see previous unit.
2. Clean the data by replacing any missing values and removing duplicate rows. In this dataset, each customer is identified by a unique customer ID. The most recent version of a duplicated record should be retained.
3. Explore the data by calculating summary and descriptive statistics for the features in the dataset, calculating correlations between features, and creating data visualizations to determine apparent relationships in the data.
4. Based on your analysis of the customer data after removing all duplicate customer records, answer the questions below.

## Initial Data Exploration

Loading the csv files into dataframes in R goes as follows.

```{r}
customerInfo <- read.csv("AdvWorksCusts.csv", stringsAsFactors = FALSE)
bikeBuyer    <- read.csv("AW_BikeBuyer.csv")
spend        <- read.csv("AW_AveMonthSpend.csv")
```

Looking at the structure of each data frame:

```{r}
customerInfo %>% str()
bikeBuyer %>% str()
spend %>% str()
```

`customerInfo` has 23 different variables, most of which are personal information for different customers. `bikeBuyer` has a customerID and a logical indicator that determines whether or not the customer bought a bike. `spend` has the same customerID as the other two data frames, but also indicates the average amount spent per month in the indicated time.

Each dataframe has 16519 observations. 




## Cleaning Data

We'll check for `NA` values and duplicate customerIDs.

```{r}
countNA <- function(x) {is.na(x) %>% sum()}

apply( customerInfo,2,countNA )
apply( bikeBuyer,   2,countNA )
apply( spend,       2,countNA )
```

None of the dataframes have `NA` values. Although not present in this data, some data sets may have NA values that show up as other values. 

Here, customerInfo shows that many customers left several fields intentionally blank (e.g. Title, MiddleName, Suffix, AddressLine2). These are different than NA values because a "" value indicates the customer did not enter any value, whereas an `NA` indicates an unknown value.

Moving on, we work to remove duplicate entries.

```{r}
customerInfo %>% nrow()
customerInfo %<>% .[!duplicated(.),]
customerInfo %>% nrow()

bikeBuyer %<>% .[!duplicated(.),]
bikeBuyer %>% nrow()

spend %<>% .[!duplicated(.),]
spend %>% nrow()
```

Here we've removed all observations (AKA customers) with exactly the same `CustomerID` values in all data frames, but we see that `bikeBuyer` ended up with fewer rows than the other dataframes. My suspicion is that although we've eliminated "total duplications", there are still several repeated `CustomerIDs` with slightly varying entries.

```{r}
customerInfo$CustomerID %>% unique() %>% length()
bikeBuyer$CustomerID %>% unique() %>% length()
spend$CustomerID %>% unique() %>% length()
```

Indeed, we see that all our data frames have some duplicated `CustomerID` values. Normally we would look for a criterion that would help us decide which values to keep, but thankfully we were provided with such a criterion at the beginning of this challenge--

2. Clean the data by replacing any missing values and removing duplicate rows. In this dataset, each customer is identified by a unique customer ID. The most recent version of a duplicated record should be retained.

Inspecting the data, we see that `CustomerID` mostly increases by one from entry to entry:

```{r}
bikeBuyer %>% head %>% as.tibble
```

This leads us to believe that earlier entries have lower row numbers. Resultingly, we can keep the highest row number from each distinct `CustomerID` to only retain the most recent version of a record. If this works, then we should see that each dataframe has 16404 rows, equal to the number of unique `CustomerID` values.

```{r}
keepOldest <- function(df){
  
  df %<>% .[nrow(.)[1]:1,] #reverse the order of rows in the df
  df %<>% distinct( #keep the first CustomerID, drop the rest
    CustomerID , .keep_all = TRUE) 
  df %<>% .[nrow(.)[1]:1,] #change the df order back to normal
  df
  
}

customerInfo %<>% keepOldest()
bikeBuyer %<>% keepOldest()
spend %<>% keepOldest()

nrow(customerInfo)
nrow(bikeBuyer)
nrow(spend)
```

Since everything seems to be working out, we'll combine all the data into one big dataframe.

```{r}
customerData <- left_join(customerInfo, bikeBuyer, by = "CustomerID") %>% 
  left_join(., spend, by = "CustomerID")
```


## Investigate Basic Trends

The tasks assigned in this challenge are to investigate some basic trends within the data.

### Spending Summary Statistics

The first few questions are about summary statistics for the `AveMonthSpend` variable. We'll plot a histogram of this variable. 

```{r}
ggplot(customerData) + 
  geom_histogram(aes(x = AveMonthSpend, alpha = .3)) + 
  geom_rug(aes(x = AveMonthSpend))
```

We see that the distribution is skewed right. We'll get a bit more quantitative information with a few summary statistics.

```{r}
summary(customerData$AveMonthSpend)
sd(customerData$AveMonthSpend)
```

With this information we can answer the first five questions.

1. Minimum AveMonthSpend: 22
2. Maximum AveMonthSpend: 176
3. Mean AveMonthSpend:    72.42
4. Median AveMonthSpend:  68
5. Standard Deviation AveMonthSpend: 27.26815

### Bike Buyers

The next question is about the distribution of bike buyers.

```{r}
ggplot(customerData, aes(x = BikeBuyer)) + 
  geom_bar()
```

6. The distribution of the values in the BikeBuyer column indicates:
  Fewer customers have bought bikes than have not bought bikes.

### YearlyIncome and Occupation

The next question asks for the rank ordering of Occupation by Median Yearly Income

```{r}
customerData %>% 
  group_by(Occupation) %>% 
  summarize(medianIncome = median(YearlyIncome), n = n()) %>% 
  arrange(medianIncome)
```



7. Select the correct order (from lowest to highest) that ranks the median YearlyIncome by Occupation:

Manual, Clerical, Skilled Manual, Professional, Management

### Monthly Spending by Age and Sex

The next question asks about monthly spending habits by age and sex.
